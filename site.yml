- name: Set up virtual machine on Proxmox
  hosts: localhost
  connection: local
  vars:
    vm_name: ansibleVm
    vm_template: ubuntu-cloud-template-v2
    proxmox_node: int531-04
    proxmox_api_host: 10.13.104.214
    proxmox_api_user: root@pam
    proxmox_api_password: int53104

  tasks:
    - name: Create VM from template (Cloud-Init + DHCP)
      community.proxmox.proxmox_kvm:
        api_user: "{{ proxmox_api_user }}"
        api_password: "{{ proxmox_api_password }}"
        api_host: "{{ proxmox_api_host }}"
        clone: "{{ vm_template }}"
        name: "{{ vm_name }}"
        node: "{{ proxmox_node }}"
        ciuser: ansible
        cipassword: int53104
        ipconfig:
          ipconfig0: "ip=dhcp"
        agent: 1
        timeout: 600
      register: vm_create

    - name: Start VM
      community.proxmox.proxmox_kvm:
        api_user: "{{ proxmox_api_user }}"
        api_password: "{{ proxmox_api_password }}"
        api_host: "{{ proxmox_api_host }}"
        vmid: "{{ vm_create.vmid }}"
        state: started

    - name: Wait for VM to boot
      pause:
        seconds: 30

    - name: Refresh inventory
      meta: refresh_inventory

- name: Configure VM
  hosts: ansibleVm
  remote_user: ansible
  become: true
  tasks:
    - wait_for_connection:
        timeout: 300

    - include_role:
        name: "{{ item }}"
      loop:
        - common
        - monitoring
        - app
